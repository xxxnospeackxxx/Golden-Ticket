<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Golden Ticket</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:url("assets/background.jpg") no-repeat center center fixed;
  background-size:contain;
  background-color:#000;
  color:#fff;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
}

.card{
  background:rgba(0,0,0,.75);
  padding:20px;
  border-radius:22px;
  width:min(420px,95vw);
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
}

h1{margin:6px 0 8px;}
p{margin:0 0 10px;}

input,button{
  width:100%;
  padding:12px;
  margin-top:12px;
  border-radius:12px;
  font-size:16px;
  border:none;
}

button{
  background:gold;
  font-weight:800;
  cursor:pointer;
}
button:disabled{opacity:.6; cursor:not-allowed;}

.wheel-wrap{
  margin:20px auto;
  width:260px;
  height:260px;
  position:relative;
  display:none;
}

.pointer{
  position:absolute;
  top:-10px;
  left:50%;
  transform:translateX(-50%);
  width:0;height:0;
  border-left:14px solid transparent;
  border-right:14px solid transparent;
  border-bottom:26px solid gold;
  z-index:5;
}

#wheel{
  position:relative;
  width:100%;
  height:100%;
  border-radius:50%;
  border:10px solid #fff;
  box-shadow:inset 0 0 0 6px rgba(0,0,0,.25),0 18px 45px rgba(0,0,0,.55);
  transform:rotate(0deg);
  background:conic-gradient(
    #c0392b 0deg 36deg,
    #e74c3c 36deg 72deg,
    #c0392b 72deg 108deg,
    #e74c3c 108deg 144deg,
    #c0392b 144deg 180deg,

    #2ecc71 180deg 216deg,
    #27ae60 216deg 252deg,
    #f1c40f 252deg 288deg,
    #f39c12 288deg 324deg,
    #9b59b6 324deg 360deg
  );
}

.labels{
  position:absolute;
  inset:0;
  border-radius:50%;
  pointer-events:none;
}

.slice-label{
  position:absolute;
  left:50%;
  top:50%;
  transform:
    rotate(var(--a))
    translateY(-95px)
    rotate(calc(-1 * var(--a)));
  transform-origin:0 0;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  font-size:20px;
  text-shadow:0 2px 6px rgba(0,0,0,.7);
}

.slice-label span{
  font-size:11px;
  font-weight:800;
  background:rgba(0,0,0,.4);
  padding:3px 6px;
  border-radius:999px;
}

#result{
  margin-top:14px;
  font-size:18px;
  font-weight:800;
  min-height:28px;
}
</style>
</head>

<body>
<div class="card">
  <h1>ğŸ¡ Golden Ticket</h1>
  <p>Pseudo Telegram</p>

  <input id="nickname" placeholder="@pseudoTelegram">
  <button id="start">Participer</button>

  <div id="wheelWrap" class="wheel-wrap">
    <div class="pointer"></div>
    <div id="wheel">
      <div class="labels">
        <!-- PERDAS (centros: 18,54,90,126,162) -->
        <div class="slice-label" style="--a:18deg;">ğŸ˜­<span>Perdu</span></div>
        <div class="slice-label" style="--a:54deg;">ğŸ˜¢<span>Perdu</span></div>
        <div class="slice-label" style="--a:90deg;">ğŸ˜<span>RÃ©essaie</span></div>
        <div class="slice-label" style="--a:126deg;">ğŸ˜”<span>Dommage</span></div>
        <div class="slice-label" style="--a:162deg;">ğŸ¥²<span>Encore</span></div>

        <!-- GANHOS (centros: 198,234,270,306,342) -->
        <div class="slice-label" style="--a:198deg;">ğŸ<span>10%</span></div>
        <div class="slice-label" style="--a:234deg;">ğŸ<span>15%</span></div>
        <div class="slice-label" style="--a:270deg;">ğŸ’¶<span>20â‚¬</span></div>
        <div class="slice-label" style="--a:306deg;">ğŸ’¶<span>50â‚¬</span></div>
        <div class="slice-label" style="--a:342deg;">ğŸ›ï¸<span>Cadeau</span></div>
      </div>
    </div>
  </div>

  <div id="result"></div>

  <audio id="spinSound" src="assets/spin.mp3" preload="auto"></audio>
</div>

<script>
const SUPABASE_URL='https://nkuywnsjredskfnypice.supabase.co';
const SUPABASE_KEY='sb_publishable_HQERWAaofXvB8m2mIV4DBQ_AR2J5nEc';
const supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const loseMessages=[
  "Perdu ğŸ˜¢â€¦ tente ta chance une prochaine fois !",
  "Pas de chance cette fois ğŸ˜”. Reviens tenter ta chance bientÃ´t !",
  "Perduâ€¦ ğŸ€ La chance tourne, rÃ©essaie plus tard !",
  "Dommage ! ğŸ˜• AchÃ¨te encore et tente ta chance Ã  nouveau !",
  "Pas gagnant cette fois âŒ. La prochaine sera peut-Ãªtre la bonne !"
];

// ğŸ”¥ Fatias com Ã¢ngulo-centro + texto correspondente (assim nunca falha)
const LOSE_SLICES = [
  { angle: 18 },
  { angle: 54 },
  { angle: 90 },
  { angle: 126 },
  { angle: 162 }
];

const WIN_SLICES = [
  { angle: 198, text: "Vous avez gagnÃ© 10% ğŸ" },
  { angle: 234, text: "Vous avez gagnÃ© 15% ğŸ" },
  { angle: 270, text: "Vous avez gagnÃ© 20â‚¬ ğŸ’¶" },
  { angle: 306, text: "Vous avez gagnÃ© 50â‚¬ ğŸ’¶" },
  { angle: 342, text: "Vous avez gagnÃ© un cadeau de la boutique ğŸ›ï¸" }
];

const token=new URLSearchParams(window.location.search).get('token');
if(!token) document.body.innerHTML="<h2 style='color:white'>Lien invalide âŒ</h2>";

const startBtn=document.getElementById('start');
const wheelWrap=document.getElementById('wheelWrap');
const wheel=document.getElementById('wheel');
const resultEl=document.getElementById('result');
const spinSound=document.getElementById('spinSound');

async function tokenUsed(){
  const {data}=await supabaseClient
    .from('participacoes')
    .select('id')
    .eq('token',token)
    .maybeSingle();
  return !!data;
}

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

// âš™ï¸ Para a roleta parar MESMO na fatia escolhida:
// Se a roda roda +Î¸, um Ã¢ngulo-alvo Î² vai para Î²+Î¸.
// Para Î² ficar no ponteiro (0Â°), queremos Î¸ â‰¡ 360-Î² (mod 360).
function rotationToLandOn(targetAngleDeg){
  const jitter = (Math.random() * 20) - 10; // -10..+10 (fica dentro da fatia)
  return (360 - targetAngleDeg + jitter);
}

startBtn.onclick=async()=>{
  const nick=document.getElementById('nickname').value.trim();
  if(!nick.startsWith('@')) return alert("Pseudo Telegram invalide");

  startBtn.disabled=true;
  resultEl.textContent="";

  if(await tokenUsed()){
    alert("Ce lien a dÃ©jÃ  Ã©tÃ© utilisÃ© âŒ");
    startBtn.disabled=false;
    return;
  }

  wheelWrap.style.display='block';

  // âœ… 50/50 real
  const isWin = Math.random() >= 0.5;

  // âœ… Escolhe a FATIA primeiro (e o texto vem dela)
  let chosenAngle, finalText;

  if (isWin){
    const slice = pick(WIN_SLICES);
    chosenAngle = slice.angle;
    finalText = slice.text;
  } else {
    const slice = pick(LOSE_SLICES);
    chosenAngle = slice.angle;
    finalText = pick(loseMessages);
  }

  // 6â€“8s sensaÃ§Ã£o: usamos 8â€“10 voltas com transiÃ§Ã£o de 7s
  const spins = 8 + Math.random() * 2;
  const finalRotation = spins * 360 + rotationToLandOn(chosenAngle);

  // RESET + animaÃ§Ã£o
  wheel.style.transition='none';
  wheel.style.transform='rotate(0deg)';
  wheel.offsetHeight;

  wheel.style.transition='transform 7s cubic-bezier(.12,.67,.12,.99)';
  wheel.style.transform=`rotate(${finalRotation}deg)`;

  // som
  spinSound.currentTime=0;
  spinSound.loop=true;
  spinSound.play().catch(()=>{});

  setTimeout(async()=>{
    spinSound.pause();
    spinSound.currentTime=0;

    resultEl.textContent=finalText;

    await supabaseClient.from('participacoes').insert({
      token:token,
      nickname:nick,
      premio:finalText
    });
  },7200);
};
</script>
</body>
</html>
