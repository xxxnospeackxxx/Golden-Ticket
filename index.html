<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Golden Ticket</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root { --card: rgba(0,0,0,.72); }

    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: url("assets/background.jpg") no-repeat center center fixed;
      background-size: cover;
      color:#fff;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    .card{
      width: min(420px, 92vw);
      background: var(--card);
      backdrop-filter: blur(6px);
      border-radius: 22px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      text-align:center;
    }

    h1{ margin:6px 0 8px; font-size: 26px; }
    p{ margin:0 0 10px; opacity:.95; }

    input, button{
      width:100%;
      padding:12px;
      margin-top:12px;
      border-radius: 12px;
      font-size: 16px;
      border: none;
      outline: none;
    }
    input{ background: rgba(255,255,255,.92); }
    button{
      background: gold;
      color:#111;
      font-weight: 800;
      cursor:pointer;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .wheel-wrap{
      margin: 18px auto 6px;
      width: 280px;
      height: 280px;
      position: relative;
      display:none;
    }

    .pointer{
      position:absolute;
      top:-10px;
      left:50%;
      transform: translateX(-50%);
      width:0;height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-bottom:26px solid gold;
      filter: drop-shadow(0 6px 8px rgba(0,0,0,.6));
      z-index:5;
    }

    #wheel{
      width:100%;
      height:100%;
      border-radius:50%;
      border: 10px solid rgba(255,255,255,.85);
      box-shadow: inset 0 0 0 6px rgba(0,0,0,.25), 0 18px 45px rgba(0,0,0,.55);
      transform: rotate(0deg);
      transition: transform 7s cubic-bezier(.12,.67,.12,.99);
      background: conic-gradient(
        /* 10 fatias (36Â° cada) -> 5 perde + 5 ganha */
        #c0392b 0deg 36deg,
        #e74c3c 36deg 72deg,
        #c0392b 72deg 108deg,
        #e74c3c 108deg 144deg,
        #c0392b 144deg 180deg,

        #2ecc71 180deg 216deg,
        #27ae60 216deg 252deg,
        #f1c40f 252deg 288deg,
        #f39c12 288deg 324deg,
        #9b59b6 324deg 360deg
      );
    }

    .legend{
      margin-top: 8px;
      font-size: 12px;
      opacity: .9;
      line-height: 1.35;
    }

    #result{
      margin-top: 14px;
      font-size: 18px;
      font-weight: 800;
      min-height: 28px;
    }

    .small{
      margin-top: 8px;
      font-size: 12px;
      opacity: .85;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>ğŸ¡ Golden Ticket</h1>
    <p>Identifiez-vous avec votre pseudo Telegram</p>

    <input id="nickname" placeholder="@pseudoTelegram" autocomplete="off" />
    <button id="start">Participer</button>

    <div id="wheelWrap" class="wheel-wrap">
      <div class="pointer"></div>
      <div id="wheel"></div>
    </div>

    <div id="result"></div>
    <div class="legend">
      <span>ğŸ”´ = Perdu</span> &nbsp;â€¢&nbsp; <span>ğŸŸ¢/ğŸŸ¡/ğŸŸ£ = Gain</span>
    </div>
    <div class="small">Une participation par lien (ticket).</div>

    <audio id="spinSound" src="assets/spin.mp3" preload="auto"></audio>
  </div>

<script>
  // âœ… Supabase
  const SUPABASE_URL = 'https://nkuywnsjredskfnypice.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_HQERWAaofXvB8m2mIV4DBQ_AR2J5nEc';
  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // âœ… 5 prÃ©mios
  const prizes = [
    "Vous avez gagnÃ© 10% ğŸ",
    "Vous avez gagnÃ© 15% ğŸ",
    "Vous avez gagnÃ© 50â‚¬ ğŸ’¶",
    "Vous avez gagnÃ© 20â‚¬ ğŸ’¶",
    "Vous avez gagnÃ© un cadeau de la boutique ğŸ›ï¸"
  ];

  // âœ… mensagens de perda (FR)
  const loseMessages = [
    "Perdu ğŸ˜¢â€¦ tente ta chance une prochaine fois !",
    "Pas de chance cette fois ğŸ˜”. Reviens tenter ta chance bientÃ´t !",
    "Perduâ€¦ ğŸ€ La chance tourne, rÃ©essaie plus tard !",
    "Dommage ! ğŸ˜• AchÃ¨te encore et tente ta chance Ã  nouveau !",
    "Pas gagnant cette fois âŒ. La prochaine sera peut-Ãªtre la bonne !"
  ];

  const token = new URLSearchParams(window.location.search).get('token');
  if (!token) document.body.innerHTML = "<h2 style='color:white;font-family:Arial'>Lien invalide âŒ</h2>";

  const startBtn = document.getElementById('start');
  const wheelWrap = document.getElementById('wheelWrap');
  const wheel = document.getElementById('wheel');
  const resultEl = document.getElementById('result');
  const spinSound = document.getElementById('spinSound');

  async function tokenUsed() {
    const { data, error } = await supabaseClient
      .from('participacoes')
      .select('id')
      .eq('token', token)
      .maybeSingle();
    if (error) return true; // se der erro, bloqueia
    return !!data;
  }

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function playSpinSound(){
    try {
      spinSound.currentTime = 0;
      spinSound.loop = true;
      // Alguns browsers bloqueiam autoplay; aqui jÃ¡ Ã© clique do user, entÃ£o deve tocar.
      spinSound.play().catch(()=>{});
    } catch(e) {}
  }

  function stopSpinSound(){
    try {
      spinSound.loop = false;
      spinSound.pause();
      spinSound.currentTime = 0;
    } catch(e) {}
  }

  startBtn.onclick = async () => {
    const nick = document.getElementById('nickname').value.trim();
    if (!nick.startsWith('@')) { alert("Pseudo Telegram invalide"); return; }

    startBtn.disabled = true;
    resultEl.textContent = "";

    if (await tokenUsed()) {
      alert("Ce lien a dÃ©jÃ  Ã©tÃ© utilisÃ© âŒ");
      startBtn.disabled = false;
      return;
    }

    wheelWrap.style.display = 'block';

    // ğŸ¯ DecisÃ£o 50/50 ANTES de rodar
    const rnd = Math.floor(Math.random() * 100); // 0..99
    const isWin = rnd >= 50;

    const finalText = isWin ? pick(prizes) : pick(loseMessages);

    // ğŸ¡ Ã‚ngulo de parada: topo = 0deg (ponteiro fixa em cima)
    // Metade vermelha (0..180) = perda ; metade (180..360) = ganho
    const stopAngle = isWin
      ? 180 + Math.floor(Math.random() * 180)  // ganha
      : Math.floor(Math.random() * 180);       // perde

    // â±ï¸ 6 a 8 segundos (nÃºmero de voltas)
    const spins = 9 + Math.random() * 2; // mais voltas dÃ¡ sensaÃ§Ã£o de 6â€“8s com transiÃ§Ã£o 7s
    const finalRotation = spins * 360 + stopAngle;

    playSpinSound();
    wheel.style.transform = `rotate(${finalRotation}deg)`;

    // quando terminar (7s) mostra resultado e grava no Supabase
    setTimeout(async () => {
      stopSpinSound();
      resultEl.textContent = finalText;

      // grava sempre (ganhe ou perca)
      const { error } = await supabaseClient.from('participacoes').insert({
        token: token,
        nickname: nick,
        premio: finalText
      });

      // se der erro, avisa (mas nÃ£o quebra)
      if (error) {
        console.log("Supabase insert error:", error);
        // opcional: alert("Erreur d'enregistrement, veuillez contacter l'administrateur.");
      }
    }, 7200); // ligeiramente > 7s

  };
</script>
</body>
</html>
