<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Golden Ticket</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  :root{
    /* roda responsiva: cresce atÃ© 360px, mas adapta ao telemÃ³vel */
    --wheel-size: min(78vw, 360px);
    --label-radius: calc(var(--wheel-size) * 0.33);
  }

  *{ box-sizing:border-box; }

  body{
    margin:0;
    font-family:Arial,sans-serif;
    background:url("assets/background.jpg") no-repeat center center fixed;
    background-size:contain;
    background-color:#000;
    color:#fff;
    min-height:100svh; /* melhor no mobile (endereÃ§o do browser) */
    display:flex;
    justify-content:center;
    align-items:center;
    padding: max(14px, env(safe-area-inset-top)) 14px max(14px, env(safe-area-inset-bottom));
  }

  .card{
    background:rgba(0,0,0,.68);
    padding:14px 14px 16px;
    border-radius:22px;
    width:min(520px, 96vw);
    text-align:center;
    box-shadow:0 20px 60px rgba(0,0,0,.6);
    backdrop-filter: blur(6px);
  }

  h1{
    margin:6px 0 8px;
    font-size:22px;
    letter-spacing:.2px;
  }

  .top-controls{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
    margin: 6px auto 6px;
  }

  input{
    width:min(280px, 92vw);
    padding:10px 12px;
    border-radius:12px;
    font-size:15px;
    border:none;
    outline:none;
  }

  button{
    padding:10px 14px;
    border-radius:12px;
    font-size:15px;
    border:none;
    background:gold;
    font-weight:800;
    cursor:pointer;
    min-width:120px;
    -webkit-tap-highlight-color: transparent;
  }
  button:disabled{opacity:.6; cursor:not-allowed;}

  .wheel-wrap{
    margin:12px auto 6px;
    width:var(--wheel-size);
    height:var(--wheel-size);
    position:relative;
    display:none;
  }

  /* ponteiro */
  .pointer{
    position:absolute;
    top:-6px;
    left:50%;
    transform:translateX(-50%);
    width:0;height:0;
    border-left:16px solid transparent;
    border-right:16px solid transparent;
    border-top:30px solid gold;
    z-index:5;
    filter: drop-shadow(0 8px 10px rgba(0,0,0,.6));
  }

  #wheel{
    position:relative;
    width:100%;
    height:100%;
    border-radius:50%;
    border:10px solid rgba(255,255,255,.92);
    box-shadow:inset 0 0 0 6px rgba(0,0,0,.22),0 18px 45px rgba(0,0,0,.55);
    transform:rotate(0deg);
    transition: transform 7s cubic-bezier(.12,.67,.12,.99);

    background:conic-gradient(
      #c0392b 0deg 36deg,
      #2ecc71 36deg 72deg,
      #e74c3c 72deg 108deg,
      #27ae60 108deg 144deg,
      #c0392b 144deg 180deg,
      #f1c40f 180deg 216deg,
      #e74c3c 216deg 252deg,
      #f39c12 252deg 288deg,
      #c0392b 288deg 324deg,
      #9b59b6 324deg 360deg
    );
  }

  .labels{
    position:absolute;
    inset:0;
    border-radius:50%;
    pointer-events:none;
  }

  .slice-icon{
    position:absolute;
    left:50%;
    top:50%;
    transform:
      translate(-50%,-50%)
      rotate(var(--a))
      translateY(calc(-1 * var(--label-radius)))
      rotate(calc(-1 * var(--a)));
    font-size: clamp(22px, 6vw, 28px); /* Ã­cone adapta no mobile */
    line-height:1;
    text-shadow:0 2px 8px rgba(0,0,0,.75);
    user-select:none;
  }

  #result{
    margin-top:10px;
    font-size: clamp(16px, 4.2vw, 18px);
    font-weight:900;
    min-height:28px;
    text-shadow:0 2px 10px rgba(0,0,0,.75);
  }

  .hint{
    margin-top:6px;
    font-size:12px;
    opacity:.85;
  }

  /* confetti */
  .confetti{
    position:fixed;
    inset:0;
    pointer-events:none;
    overflow:hidden;
    z-index:9999;
  }
  .confetti i{
    position:absolute;
    top:-20px;
    width:10px;
    height:16px;
    opacity:.95;
    border-radius:3px;
    transform: translateY(-20px) rotate(0deg);
    animation: fall var(--d) linear forwards;
    left: var(--x);
    filter: drop-shadow(0 6px 10px rgba(0,0,0,.45));
  }
  @keyframes fall{
    to { transform: translateY(110vh) rotate(720deg); }
  }

  /* âœ… mobile: input + botÃ£o um por linha, mais espaÃ§o para a roda */
  @media (max-width: 520px){
    .top-controls{
      flex-direction: column;
      gap:8px;
    }
    input{ width: 100%; }
    button{ width: 100%; min-width: 0; }
  }
</style>
</head>

<body>
<div class="card">
  <h1>ğŸ¡ Golden Ticket</h1>

  <div class="top-controls">
    <input id="nickname" placeholder="@pseudoTelegram" inputmode="text" autocapitalize="none" autocomplete="off">
    <button id="start">Participer</button>
  </div>

  <div id="wheelWrap" class="wheel-wrap">
    <div class="pointer"></div>
    <div id="wheel">
      <div class="labels">
        <!-- PERDE -->
        <div class="slice-icon" style="--a:18deg;">ğŸ˜­</div>
        <div class="slice-icon" style="--a:90deg;">ğŸ˜¢</div>
        <div class="slice-icon" style="--a:162deg;">ğŸ˜</div>
        <div class="slice-icon" style="--a:234deg;">ğŸ˜”</div>
        <div class="slice-icon" style="--a:306deg;">ğŸ¥²</div>

        <!-- GANHA -->
        <div class="slice-icon" style="--a:54deg;">ğŸ·ï¸</div>
        <div class="slice-icon" style="--a:126deg;">ğŸ·ï¸</div>
        <div class="slice-icon" style="--a:198deg;">ğŸ’¶</div>
        <div class="slice-icon" style="--a:270deg;">ğŸ’¶</div>
        <div class="slice-icon" style="--a:342deg;">ğŸ›ï¸</div>
      </div>
    </div>
  </div>

  <div id="result"></div>
  <div class="hint">Une participation par lien (ticket).</div>

  <audio id="spinSound" src="assets/spin.mp3" preload="auto"></audio>
</div>

<script>
  const SUPABASE_URL='https://nkuywnsjredskfnypice.supabase.co';
  const SUPABASE_KEY='sb_publishable_HQERWAaofXvB8m2mIV4DBQ_AR2J5nEc';
  const supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

  const loseMessages=[
    "Perdu ğŸ˜¢â€¦ tente ta chance une prochaine fois !",
    "Pas de chance cette fois ğŸ˜”. Reviens tenter ta chance bientÃ´t !",
    "Perduâ€¦ ğŸ€ La chance tourne, rÃ©essaie plus tard !",
    "Dommage ! ğŸ˜• AchÃ¨te encore et tente ta chance Ã  nouveau !",
    "Pas gagnant cette fois âŒ. La prochaine sera peut-Ãªtre la bonne !"
  ];

  const LOSE_SLICES=[18,90,162,234,306];
  const WIN_SLICES=[
    {angle:54,  text:"Vous avez gagnÃ© 10% ğŸ"},
    {angle:126, text:"Vous avez gagnÃ© 15% ğŸ"},
    {angle:198, text:"Vous avez gagnÃ© 20â‚¬ ğŸ’¶"},
    {angle:270, text:"Vous avez gagnÃ© 50â‚¬ ğŸ’¶"},
    {angle:342, text:"Vous avez gagnÃ© un cadeau de la boutique ğŸ›ï¸"}
  ];

  const token=new URLSearchParams(window.location.search).get('token');
  if(!token) document.body.innerHTML="<h2 style='color:white;font-family:Arial'>Lien invalide âŒ</h2>";

  const startBtn=document.getElementById('start');
  const wheelWrap=document.getElementById('wheelWrap');
  const wheel=document.getElementById('wheel');
  const resultEl=document.getElementById('result');
  const spinSound=document.getElementById('spinSound');

  async function tokenUsed(){
    const {data}=await supabaseClient
      .from('participacoes')
      .select('id')
      .eq('token',token)
      .maybeSingle();
    return !!data;
  }

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function rotationToLandOn(targetAngle){
    const jitter = (Math.random()*12) - 6;
    return (360 - targetAngle + jitter);
  }

  function launchConfetti(){
    const c = document.createElement('div');
    c.className = 'confetti';
    const colors = ['#ffd166','#06d6a0','#ef476f','#118ab2','#ffffff','#f77f00','#8338ec'];

    for(let i=0;i<70;i++){
      const p=document.createElement('i');
      p.style.background = colors[Math.floor(Math.random()*colors.length)];
      p.style.setProperty('--x', (Math.random()*100)+'vw');
      p.style.setProperty('--d', (2.2 + Math.random()*1.2)+'s');
      p.style.animationDelay = (Math.random()*0.4)+'s';
      p.style.transform = `translateY(-20px) rotate(${Math.random()*180}deg)`;
      c.appendChild(p);
    }
    document.body.appendChild(c);
    setTimeout(()=> c.remove(), 3200);
  }

  startBtn.onclick=async()=>{
    const nick=document.getElementById('nickname').value.trim();
    if(!nick.startsWith('@')) return alert("Pseudo Telegram invalide");

    startBtn.disabled=true;
    resultEl.textContent="";

    if(await tokenUsed()){
      alert("Ce lien a dÃ©jÃ  Ã©tÃ© utilisÃ© âŒ");
      startBtn.disabled=false;
      return;
    }

    wheelWrap.style.display='block';

    const isWin = Math.random() >= 0.5;
    let chosenAngle, finalText;

    if(isWin){
      const s = pick(WIN_SLICES);
      chosenAngle = s.angle;
      finalText = s.text;
    }else{
      chosenAngle = pick(LOSE_SLICES);
      finalText = pick(loseMessages);
    }

    const fullSpins = 8 + Math.floor(Math.random()*3); // 8..10
    const finalRotation = fullSpins*360 + rotationToLandOn(chosenAngle);

    wheel.style.transition='none';
    wheel.style.transform='rotate(0deg)';
    wheel.offsetHeight;
    wheel.style.transition='transform 7s cubic-bezier(.12,.67,.12,.99)';
    wheel.style.transform=`rotate(${finalRotation}deg)`;

    spinSound.currentTime=0;
    spinSound.loop=true;
    spinSound.play().catch(()=>{});

    setTimeout(async()=>{
      spinSound.pause();
      spinSound.currentTime=0;

      if(isWin) launchConfetti();
      resultEl.textContent=finalText;

      await supabaseClient.from('participacoes').insert({
        token: token,
        nickname: nick,
        premio: finalText
      });
    }, 7200);
  };
</script>
</body>
</html>
