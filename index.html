<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Golden Ticket Debug</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial; background:#f5f5f5; display:flex; justify-content:center; align-items:center; height:100vh; }
    .card { background:#fff; padding:24px; border-radius:16px; width:360px; box-shadow:0 10px 30px rgba(0,0,0,.1); text-align:center; }
    input, button { width:100%; padding:12px; margin-top:12px; border-radius:10px; font-size:16px; }
    button { background:#4f46e5; color:#fff; border:none; cursor:pointer; }
    .scratch { margin-top:20px; padding:30px; background:#ddd; border-radius:12px; cursor:pointer; font-weight:bold; font-size:18px; display:none; }
    .result { font-size:20px; margin-top:20px; font-weight:bold; color:#111; }
  </style>
</head>
<body>
<div class="card">
  <h2>Carte Ã  gratter Debug ğŸ‰</h2>
  <p>Identifiez-vous avec votre pseudo Telegram</p>
  <input id="nickname" placeholder="@pseudoTelegram" />
  <button id="start">Participer</button>
  <div id="scratch" class="scratch">Grattez ici ğŸ‘†</div>
  <div id="result" class="result"></div>
</div>

<script>
  const SUPABASE_URL = 'https://nkuywnsjredskfnypice.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_HQERWAaofXvB8m2mIV4DBQ_AR2J5nEc';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const prizes = [
    'Vous avez gagnÃ© 10% ğŸ',
    'Vous avez gagnÃ© 15% ğŸ',
    'Vous avez gagnÃ© 50â‚¬ ğŸ’¶',
    'Vous avez gagnÃ© 20â‚¬ ğŸ’¶',
    'Vous avez gagnÃ© un cadeau de la boutique ğŸ›ï¸'
  ];

  const token = new URLSearchParams(window.location.search).get('token');

  if (!token) {
    alert("Erreur: Token invalide ou manquant !");
    document.body.innerHTML = '<h2>Lien invalide âŒ</h2>';
  } else {
    alert("Token dÃ©tectÃ©: " + token);
  }

  async function tokenUsed() {
    try {
      const { data, error } = await supabase
        .from('participacoes')
        .select('id')
        .eq('token', token)
        .maybeSingle();
      if (error) { alert("Erreur Supabase: " + error.message); return true; }
      return data;
    } catch (err) {
      alert("Erreur JS: " + err);
      return true;
    }
  }

  document.getElementById('start').onclick = async () => {
    const nick = document.getElementById('nickname').value.trim();
    alert("Pseudo entrÃ©: " + nick);

    if (!nick.startsWith('@')) { alert('Pseudo Telegram invalide'); return; }

    const used = await tokenUsed();
    if (used) { alert('Ce lien a dÃ©jÃ  Ã©tÃ© utilisÃ© âŒ ou erreur Supabase'); return; }

    alert("Token OK, on peut afficher la zone de grattage !");
    document.getElementById('scratch').style.display = 'block';
  };

  document.getElementById('scratch').onclick = async () => {
    const prize = prizes[Math.floor(Math.random() * prizes.length)];
    alert("Vous avez gagnÃ©: " + prize);

    try {
      const { error } = await supabase.from('participacoes').insert({
        token: token,
        nickname: document.getElementById('nickname').value,
        premio: prize
      });
      if (error) alert("Erreur insertion Supabase: " + error.message);
    } catch(err) {
      alert("Erreur JS lors de l'insertion: " + err);
    }

    document.getElementById('result').innerText = prize;
    document.getElementById('scratch').style.display = 'none';
  };
</script>
</body>
</html>
