<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Golden Ticket</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      background: #1f1f1f;
      padding: 24px;
      border-radius: 16px;
      width: 360px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border-radius: 10px;
      font-size: 16px;
      border: none;
    }
    button {
      background: gold;
      font-weight: bold;
      cursor: pointer;
    }
    .scratch {
      margin-top: 20px;
      padding: 30px;
      background: #333;
      border-radius: 12px;
      cursor: pointer;
      font-size: 18px;
      display: none;
    }
    .result {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="card">
  <h2>ğŸŸï¸ Golden Ticket</h2>
  <p>Entrez votre pseudo Telegram</p>
  <input id="nickname" placeholder="@pseudoTelegram">
  <button id="start">Participer</button>

  <div id="scratch" class="scratch">ğŸ‰ Grattez ici ğŸ‰</div>
  <div id="result" class="result"></div>
</div>

<script>
  // ğŸ” Supabase
  const SUPABASE_URL = 'https://nkuywnsjredskfnypice.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_HQERWAaofXvB8m2mIV4DBQ_AR2J5nEc';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ğŸ† PrÃ©mios
  const prizes = [
    "Vous avez gagnÃ© 10% ğŸ",
    "Vous avez gagnÃ© 15% ğŸ",
    "Vous avez gagnÃ© 50â‚¬ ğŸ’¶",
    "Vous avez gagnÃ© 20â‚¬ ğŸ’¶",
    "Vous avez gagnÃ© un cadeau de la boutique ğŸ›ï¸"
  ];

  // âŒ Messages de perte
  const loseMessages = [
    "Perdu ğŸ˜¢â€¦ tente ta chance une prochaine fois !",
    "Pas de chance cette fois ğŸ˜”. Reviens tenter ta chance bientÃ´t !",
    "Perduâ€¦ ğŸ€ La chance tourne, rÃ©essaie plus tard !",
    "Dommage ! ğŸ˜• AchÃ¨te encore et tente ta chance Ã  nouveau !",
    "Pas gagnant cette fois âŒ. La prochaine sera peut-Ãªtre la bonne !"
  ];

  // ğŸ”‘ Token unique
  const token = new URLSearchParams(window.location.search).get('token');
  if (!token) {
    document.body.innerHTML = "<h2>Lien invalide âŒ</h2>";
  }

  async function tokenUsed() {
    const { data } = await supabaseClient
      .from('participacoes')
      .select('id')
      .eq('token', token)
      .maybeSingle();
    return data;
  }

  // â–¶ï¸ Participer
  document.getElementById('start').onclick = async () => {
    const nick = document.getElementById('nickname').value.trim();
    if (!nick.startsWith('@')) {
      alert("Pseudo Telegram invalide");
      return;
    }

    if (await tokenUsed()) {
      alert("Ce lien a dÃ©jÃ  Ã©tÃ© utilisÃ© âŒ");
      return;
    }

    document.getElementById('scratch').style.display = 'block';
  };

  // ğŸ¯ LOGIQUE 50/50
  document.getElementById('scratch').onclick = async () => {
    const random = Math.floor(Math.random() * 100); // 0â€“99
    let resultText = "";

    if (random < 50) {
      // âŒ PERDE
      resultText = loseMessages[Math.floor(Math.random() * loseMessages.length)];
    } else {
      // âœ… GANHA
      resultText = prizes[Math.floor(Math.random() * prizes.length)];
    }

    await supabaseClient.from('participacoes').insert({
      token: token,
      nickname: document.getElementById('nickname').value,
      premio: resultText
    });

    document.getElementById('result').innerText = resultText;
    document.getElementById('scratch').style.display = 'none';
  };
</script>

</body>
</html>
