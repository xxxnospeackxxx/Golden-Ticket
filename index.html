<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Golden Ticket</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  :root{
    --wheel-size: 360px;   /* ğŸ‘ˆ roda maior */
    --label-radius: 118px; /* ğŸ‘ˆ posiÃ§Ã£o dos Ã­cones (centro de cada fatia) */
  }

  body{
    margin:0;
    font-family:Arial,sans-serif;
    background:url("assets/background.jpg") no-repeat center center fixed;
    background-size:contain;
    background-color:#000;
    color:#fff;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    padding:18px;
  }

  .card{
    background:rgba(0,0,0,.68);
    padding:14px 14px 16px;
    border-radius:22px;
    width:min(520px, 95vw);
    text-align:center;
    box-shadow:0 20px 60px rgba(0,0,0,.6);
    backdrop-filter: blur(6px);
  }

  h1{
    margin:6px 0 6px;
    font-size:24px; /* ğŸ‘ˆ tÃ­tulo um pouco menor */
    letter-spacing:.2px;
  }

  .top-controls{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
    margin: 6px auto 6px;
  }

  input{
    width:min(260px, 80vw); /* ğŸ‘ˆ caixa menor */
    padding:10px 12px;
    border-radius:12px;
    font-size:15px;
    border:none;
    outline:none;
  }

  button{
    padding:10px 14px;
    border-radius:12px;
    font-size:15px;
    border:none;
    background:gold;
    font-weight:800;
    cursor:pointer;
    min-width:120px; /* ğŸ‘ˆ botÃ£o menor */
  }
  button:disabled{opacity:.6; cursor:not-allowed;}

  .wheel-wrap{
    margin:12px auto 6px;
    width:var(--wheel-size);
    height:var(--wheel-size);
    position:relative;
    display:none;
  }

  /* ğŸ”½ ponteiro aponta para baixo */
  .pointer{
    position:absolute;
    top:-6px;
    left:50%;
    transform:translateX(-50%);
    width:0;height:0;
    border-left:16px solid transparent;
    border-right:16px solid transparent;
    border-top:30px solid gold;
    z-index:5;
    filter: drop-shadow(0 8px 10px rgba(0,0,0,.6));
  }

  #wheel{
    position:relative;
    width:100%;
    height:100%;
    border-radius:50%;
    border:10px solid rgba(255,255,255,.92);
    box-shadow:inset 0 0 0 6px rgba(0,0,0,.22),0 18px 45px rgba(0,0,0,.55);
    transform:rotate(0deg);

    /* 10 fatias intercaladas: perde / ganha */
    background:conic-gradient(
      #c0392b 0deg 36deg,
      #2ecc71 36deg 72deg,
      #e74c3c 72deg 108deg,
      #27ae60 108deg 144deg,
      #c0392b 144deg 180deg,
      #f1c40f 180deg 216deg,
      #e74c3c 216deg 252deg,
      #f39c12 252deg 288deg,
      #c0392b 288deg 324deg,
      #9b59b6 324deg 360deg
    );
  }

  .labels{
    position:absolute;
    inset:0;
    border-radius:50%;
    pointer-events:none;
  }

  /* âœ… Ãcones centrados no raio desejado */
  .slice-icon{
    position:absolute;
    left:50%;
    top:50%;
    transform:
      translate(-50%,-50%)
      rotate(var(--a))
      translateY(calc(-1 * var(--label-radius)))
      rotate(calc(-1 * var(--a)));
    font-size:28px;          /* ğŸ‘ˆ Ã­cones maiores */
    line-height:1;
    text-shadow:0 2px 8px rgba(0,0,0,.75);
    user-select:none;
  }

  #result{
    margin-top:10px;
    font-size:18px;
    font-weight:900;
    min-height:28px;
    text-shadow:0 2px 10px rgba(0,0,0,.75);
  }

  .hint{
    margin-top:6px;
    font-size:12px;
    opacity:.85;
  }

  /* Melhor em telas pequenas */
  @media (max-width:420px){
    :root{ --wheel-size: 320px; --label-radius: 105px; }
    .slice-icon{ font-size:26px; }
  }
</style>
</head>

<body>
<div class="card">
  <h1>ğŸ¡ Golden Ticket</h1>

  <div class="top-controls">
    <input id="nickname" placeholder="@pseudoTelegram">
    <button id="start">Participer</button>
  </div>

  <div id="wheelWrap" class="wheel-wrap">
    <div class="pointer"></div>
    <div id="wheel">
      <div class="labels">
        <!-- Centros: 18,54,90,126,162,198,234,270,306,342 -->
        <!-- PERDE -->
        <div class="slice-icon" style="--a:18deg;">ğŸ˜­</div>
        <div class="slice-icon" style="--a:90deg;">ğŸ˜¢</div>
        <div class="slice-icon" style="--a:162deg;">ğŸ˜</div>
        <div class="slice-icon" style="--a:234deg;">ğŸ˜”</div>
        <div class="slice-icon" style="--a:306deg;">ğŸ¥²</div>

        <!-- GANHA -->
        <div class="slice-icon" style="--a:54deg;">ğŸ</div>
        <div class="slice-icon" style="--a:126deg;">ğŸ</div>
        <div class="slice-icon" style="--a:198deg;">ğŸ’¶</div>
        <div class="slice-icon" style="--a:270deg;">ğŸ’¶</div>
        <div class="slice-icon" style="--a:342deg;">ğŸ›ï¸</div>
      </div>
    </div>
  </div>

  <div id="result"></div>
  <div class="hint">Une participation par lien (ticket).</div>

  <audio id="spinSound" src="assets/spin.mp3" preload="auto"></audio>
</div>

<script>
  const SUPABASE_URL='https://nkuywnsjredskfnypice.supabase.co';
  const SUPABASE_KEY='sb_publishable_HQERWAaofXvB8m2mIV4DBQ_AR2J5nEc';
  const supabaseClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

  const loseMessages=[
    "Perdu ğŸ˜¢â€¦ tente ta chance une prochaine fois !",
    "Pas de chance cette fois ğŸ˜”. Reviens tenter ta chance bientÃ´t !",
    "Perduâ€¦ ğŸ€ La chance tourne, rÃ©essaie plus tard !",
    "Dommage ! ğŸ˜• AchÃ¨te encore et tente ta chance Ã  nouveau !",
    "Pas gagnant cette fois âŒ. La prochaine sera peut-Ãªtre la bonne !"
  ];

  // Fatias intercaladas
  const LOSE_SLICES=[18,90,162,234,306];
  const WIN_SLICES=[
    {angle:54,  text:"Vous avez gagnÃ© 10% ğŸ"},
    {angle:126, text:"Vous avez gagnÃ© 15% ğŸ"},
    {angle:198, text:"Vous avez gagnÃ© 20â‚¬ ğŸ’¶"},
    {angle:270, text:"Vous avez gagnÃ© 50â‚¬ ğŸ’¶"},
    {angle:342, text:"Vous avez gagnÃ© un cadeau de la boutique ğŸ›ï¸"}
  ];

  const token=new URLSearchParams(window.location.search).get('token');
  if(!token) document.body.innerHTML="<h2 style='color:white;font-family:Arial'>Lien invalide âŒ</h2>";

  const startBtn=document.getElementById('start');
  const wheelWrap=document.getElementById('wheelWrap');
  const wheel=document.getElementById('wheel');
  const resultEl=document.getElementById('result');
  const spinSound=document.getElementById('spinSound');

  async function tokenUsed(){
    const {data}=await supabaseClient
      .from('participacoes')
      .select('id')
      .eq('token',token)
      .maybeSingle();
    return !!data;
  }

  function rotationToLandOn(target){
    const jitter=(Math.random()*20)-10; // mantÃ©m dentro da fatia
    return 360-target+jitter;
  }

  startBtn.onclick=async()=>{
    const nick=document.getElementById('nickname').value.trim();
    if(!nick.startsWith('@')) return alert("Pseudo Telegram invalide");

    startBtn.disabled=true;
    resultEl.textContent="";

    if(await tokenUsed()){
      alert("Ce lien a dÃ©jÃ  Ã©tÃ© utilisÃ© âŒ");
      startBtn.disabled=false;
      return;
    }

    wheelWrap.style.display='block';

    const isWin=Math.random()>=0.5; // 50/50
    let angle,finalText;

    if(isWin){
      const s=WIN_SLICES[Math.floor(Math.random()*WIN_SLICES.length)];
      angle=s.angle;
      finalText=s.text;
    }else{
      angle=LOSE_SLICES[Math.floor(Math.random()*LOSE_SLICES.length)];
      finalText=loseMessages[Math.floor(Math.random()*loseMessages.length)];
    }

    const spins=8+Math.random()*2; // sensaÃ§Ã£o 6â€“8s
    const finalRotation=spins*360+rotationToLandOn(angle);

    // reset + animaÃ§Ã£o
    wheel.style.transition='none';
    wheel.style.transform='rotate(0deg)';
    wheel.offsetHeight;
    wheel.style.transition='transform 7s cubic-bezier(.12,.67,.12,.99)';
    wheel.style.transform=`rotate(${finalRotation}deg)`;

    // som
    spinSound.currentTime=0;
    spinSound.loop=true;
    spinSound.play().catch(()=>{});

    setTimeout(async()=>{
      spinSound.pause();
      spinSound.currentTime=0;

      resultEl.textContent=finalText;

      await supabaseClient.from('participacoes').insert({
        token:token,
        nickname:nick,
        premio:finalText
      });
    },7200);
  };
</script>
</body>
</html>
